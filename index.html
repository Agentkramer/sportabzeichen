<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f59e0b">
  <title>Deutsches Sportabzeichen</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230f172a' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' font-size='50'>üèÖ</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      min-height: 100vh;
      min-height: 100dvh;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: linear-gradient(to right, #1e293b, #0f172a);
      border-bottom: 1px solid #334155;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 640px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #fbbf24, #d97706);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .logo-text h1 {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .logo-text p {
      font-size: 0.7rem;
      color: #94a3b8;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      touch-action: manipulation;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn-primary {
      background: linear-gradient(to right, #f59e0b, #d97706);
      color: #000;
      font-weight: 600;
    }

    .btn-primary:active {
      background: linear-gradient(to right, #fbbf24, #f59e0b);
    }

    .btn-secondary {
      background: #334155;
      color: #f1f5f9;
    }

    .btn-secondary:active {
      background: #475569;
    }

    .btn-success {
      background: #059669;
      color: #fff;
    }

    .btn-success:active {
      background: #10b981;
    }

    .btn-danger {
      background: rgba(127, 29, 29, 0.5);
      color: #fca5a5;
    }

    .btn-danger:active {
      background: #991b1b;
    }

    .btn-icon {
      padding: 0.6rem;
      min-width: 44px;
      min-height: 44px;
    }

    .btn-full {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
    }

    /* Main */
    .main {
      max-width: 640px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
      padding-bottom: 2rem;
    }

    /* Status */
    .status-bar {
      background: #1e293b;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.online { background: #22c55e; }
    .status-dot.offline { background: #ef4444; }
    .status-dot.loading { background: #f59e0b; animation: pulse 1s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-state h2 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      color: #94a3b8;
      margin-bottom: 1.5rem;
    }

    /* Cards */
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid #334155;
      margin-bottom: 0.75rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .card-name {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .card-meta {
      font-size: 0.8rem;
      color: #94a3b8;
    }

    .medal-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      white-space: nowrap;
    }

    .medal-gold { background: #fbbf24; color: #000; }
    .medal-silber { background: #d1d5db; color: #000; }
    .medal-bronze { background: #b45309; color: #fff; }

    .points-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .points-item {
      text-align: center;
    }

    .points-icon {
      font-size: 1.25rem;
    }

    .points-value {
      font-size: 0.9rem;
      font-weight: 700;
    }

    .points-0 { color: #64748b; }
    .points-1 { color: #b45309; }
    .points-2 { color: #d1d5db; }
    .points-3 { color: #fbbf24; }

    .card-actions {
      display: flex;
      gap: 0.5rem;
    }

    .card-actions .btn {
      flex: 1;
    }

    .card-actions .btn-danger {
      flex: 0;
      min-width: 50px;
    }

    /* Form */
    .form-section {
      background: #1e293b;
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid #334155;
      margin-bottom: 1rem;
    }

    .form-section h3 {
      font-size: 0.95rem;
      font-weight: 500;
      color: #cbd5e1;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .form-header h2 {
      font-size: 1.25rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    input, select {
      width: 100%;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      padding: 0.875rem 1rem;
      color: #f1f5f9;
      font-size: 16px; /* Prevents zoom on iOS */
      font-family: inherit;
      margin-bottom: 0.75rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    input::placeholder {
      color: #64748b;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .input-row input,
    .input-row select {
      margin-bottom: 0;
    }

    .result-input-group {
      display: flex;
      gap: 0.75rem;
      align-items: stretch;
    }

    .result-input-group input {
      flex: 1;
      margin-bottom: 0;
    }

    .result-points {
      min-width: 70px;
      padding: 0.875rem 0.5rem;
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .result-points-0 { background: #475569; color: #94a3b8; }
    .result-points-1 { background: #b45309; color: #fff; }
    .result-points-2 { background: #d1d5db; color: #000; }
    .result-points-3 { background: #fbbf24; color: #000; }

    .thresholds {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      font-size: 0.7rem;
      color: #94a3b8;
      margin-top: 0.5rem;
    }

    .exercise-note {
      font-size: 0.7rem;
      color: #64748b;
      font-style: italic;
      margin-top: 0.25rem;
    }

    .form-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .form-actions .btn {
      flex: 1;
      padding: 1rem;
      font-size: 1rem;
      border-radius: 12px;
    }

    /* Import Section */
    .import-section {
      border: 2px dashed #475569;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .import-section p {
      color: #94a3b8;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .file-input {
      display: none;
    }

    /* Footer */
    .footer {
      max-width: 640px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
      text-align: center;
      font-size: 0.75rem;
      color: #64748b;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #334155;
      border-top-color: #f59e0b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">üèÖ</div>
        <div class="logo-text">
          <h1>Sportabzeichen</h1>
          <p>Auswertung 2024</p>
        </div>
      </div>
      <div class="header-actions" id="headerActions">
        <button id="importBtn" class="btn btn-secondary btn-icon" title="CSV Import">üì§</button>
        <button id="exportBtn" class="btn btn-success btn-icon" title="CSV Export">üì•</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    
    <!-- Status -->
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Verbinde...</span>
    </div>

    <!-- Teilnehmerliste -->
    <div id="listView">
      <div id="emptyState" class="empty-state">
        <div class="icon">üéΩ</div>
        <h2>Keine Teilnehmer</h2>
        <p>F√ºge deinen ersten Teilnehmer hinzu</p>
      </div>
      
      <div id="participantList"></div>
      
      <button id="addBtn" class="btn btn-primary btn-full" style="margin-top: 1rem;">
        + Teilnehmer hinzuf√ºgen
      </button>
    </div>

    <!-- Formular -->
    <div id="formView" class="hidden">
      <div class="form-header">
        <h2 id="formTitle">Neuer Teilnehmer</h2>
        <button id="closeFormBtn" class="close-btn">‚úï</button>
      </div>

      <div class="form-section">
        <h3>üë§ Stammdaten</h3>
        <input type="text" id="firstNameInput" placeholder="Vorname" autocomplete="off">
        <input type="text" id="lastNameInput" placeholder="Nachname" autocomplete="off">
        <div class="input-row">
        <select id="birthYearInput" required>
            <option value="">Geburtsjahr w√§hlen</option>
        </select>
          <select id="genderInput">
            <option value="weiblich">Weiblich</option>
            <option value="maennlich">M√§nnlich</option>
          </select>
        </div>
      </div>

      <div id="disciplinesForms"></div>

      <div class="form-actions">
        <button id="cancelBtn" class="btn btn-secondary">Abbrechen</button>
        <button id="saveBtn" class="btn btn-primary">Speichern</button>
      </div>
    </div>

    <!-- Import View -->
    <div id="importView" class="hidden">
      <div class="form-header">
        <h2>CSV Import</h2>
        <button id="closeImportBtn" class="close-btn">‚úï</button>
      </div>

      <div class="import-section">
       <p>Lade eine CSV-Datei mit Teilnehmern hoch.<br>Format: Vorname;Nachname;Alter;Geschlecht</p>
        <input type="file" id="fileInput" class="file-input" accept=".csv,.txt">
        <button id="selectFileBtn" class="btn btn-secondary">Datei ausw√§hlen</button>
      </div>

      <div class="form-section hidden" id="importPreview">
        <h3>üìã Vorschau</h3>
        <div id="previewContent"></div>
      </div>

      <div class="form-actions">
        <button id="cancelImportBtn" class="btn btn-secondary">Abbrechen</button>
        <button id="confirmImportBtn" class="btn btn-primary hidden">Importieren</button>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="footer">
    Deutsches Sportabzeichen ‚Äì Leistungstabellen g√ºltig ab 2024
  </footer>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // ============================================
    // SUPABASE CONFIG
    // ============================================
    const SUPABASE_URL = 'https://uuawbivebnknxnegrolu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YXdiaXZlYm5rbnhuZWdyb2x1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTg5MTksImV4cCI6MjA4NTY3NDkxOX0.T5RCoPZSGuyRSxon-LNWAgefXf_WWN7VN4tBoIzwprQ';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ============================================
    // LEISTUNGSTABELLEN
    // ============================================
    const PERFORMANCE_DATA = {
      weiblich: {
        "10-11": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "05:20", silber: "04:40", gold: "04:00", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 15, silber: 20, gold: 30, lowerIsBetter: false },
            "schwimmen_200m": { unit: "min:sec", bronze: "07:20", silber: "06:25", gold: "05:30", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "50:30", silber: "43:00", gold: "35:30", lowerIsBetter: true },
          },
          kraft: {
            "schlagball_80g": { unit: "m", bronze: 11, silber: 15, gold: 18, lowerIsBetter: false },
            "medizinball_1kg": { unit: "m", bronze: 5.0, silber: 6.0, gold: 7.0, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 1.30, silber: 1.45, gold: 1.65, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_50m": { unit: "sec", bronze: 11.0, silber: 10.1, gold: 9.1, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 39.0, silber: 31.5, gold: 25.5, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 37.0, silber: 32.0, gold: 27.0, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 0.80, silber: 0.90, gold: 1.00, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 2.30, silber: 2.60, gold: 2.90, lowerIsBetter: false },
            "drehwurf": { unit: "Pkt", bronze: 27, silber: 30, gold: 36, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 20, silber: 30, gold: 40, lowerIsBetter: false, note: "Grundsprung vorw√§rts ohne Zwischensprung" },
          }
        },
        "12-13": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "05:10", silber: "04:25", gold: "03:45", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 20, silber: 30, gold: 40, lowerIsBetter: false },
            "schwimmen_400m": { unit: "min:sec", bronze: "14:50", silber: "12:55", gold: "11:00", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "45:00", silber: "39:30", gold: "33:30", lowerIsBetter: true },
          },
          kraft: {
            "schlagball_80g": { unit: "m", bronze: 15, silber: 18, gold: 22, lowerIsBetter: false },
            "kugel_3kg": { unit: "m", bronze: 4.75, silber: 5.25, gold: 5.75, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 1.40, silber: 1.60, gold: 1.80, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_50m": { unit: "sec", bronze: 10.6, silber: 9.6, gold: 8.5, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 35.0, silber: 29.0, gold: 23.5, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 31.0, silber: 27.0, gold: 23.5, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 0.90, silber: 1.00, gold: 1.10, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 2.80, silber: 3.10, gold: 3.40, lowerIsBetter: false },
            "schleuderball_1kg": { unit: "m", bronze: 17.0, silber: 19.5, gold: 22.0, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 10, silber: 20, gold: 30, lowerIsBetter: false, note: "Grundsprung r√ºckw√§rts ohne Zwischensprung" },
          }
        },
        "14-15": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "05:00", silber: "04:20", gold: "03:35", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 30, silber: 40, gold: 50, lowerIsBetter: false },
            "schwimmen_400m": { unit: "min:sec", bronze: "13:05", silber: "11:40", gold: "10:00", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "38:00", silber: "32:30", gold: "28:30", lowerIsBetter: true },
          },
          kraft: {
            "wurfball_200g": { unit: "m", bronze: 20, silber: 24, gold: 27, lowerIsBetter: false },
            "kugel_3kg": { unit: "m", bronze: 5.50, silber: 6.00, gold: 6.50, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 1.55, silber: 1.70, gold: 1.90, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_100m": { unit: "sec", bronze: 18.6, silber: 17.0, gold: 15.5, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 33.0, silber: 27.5, gold: 21.5, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 27.0, silber: 24.5, gold: 21.5, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 0.95, silber: 1.05, gold: 1.15, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 3.20, silber: 3.50, gold: 3.80, lowerIsBetter: false },
            "schleuderball_1kg": { unit: "m", bronze: 19.5, silber: 22.5, gold: 25.5, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 10, silber: 15, gold: 20, lowerIsBetter: false, note: "Kreuzdurchschlag ohne Zwischensprung" },
          }
        },
        "16-17": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "04:50", silber: "04:05", gold: "03:25", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 45, silber: 60, gold: 75, lowerIsBetter: false },
            "schwimmen_400m": { unit: "min:sec", bronze: "11:50", silber: "10:30", gold: "09:05", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "32:30", silber: "28:30", gold: "25:00", lowerIsBetter: true },
          },
          kraft: {
            "wurfball_200g": { unit: "m", bronze: 24, silber: 27, gold: 31, lowerIsBetter: false },
            "kugel_3kg": { unit: "m", bronze: 5.75, silber: 6.25, gold: 6.75, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 1.65, silber: 1.80, gold: 2.00, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_100m": { unit: "sec", bronze: 17.6, silber: 16.3, gold: 15.0, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 30.5, silber: 25.5, gold: 20.0, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 25.0, silber: 22.5, gold: 20.0, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 1.05, silber: 1.15, gold: 1.25, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 3.40, silber: 3.70, gold: 4.00, lowerIsBetter: false },
            "schleuderball_1kg": { unit: "m", bronze: 22.0, silber: 25.0, gold: 28.0, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 10, silber: 15, gold: 20, lowerIsBetter: false, note: "Kreuzdurchschlag ohne Zwischensprung" },
          }
        }
      },
      maennlich: {
        "10-11": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "05:05", silber: "04:20", gold: "03:35", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 17, silber: 25, gold: 35, lowerIsBetter: false },
            "schwimmen_200m": { unit: "min:sec", bronze: "07:00", silber: "06:20", gold: "05:10", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "48:30", silber: "41:00", gold: "33:30", lowerIsBetter: true },
          },
          kraft: {
            "schlagball_80g": { unit: "m", bronze: 21, silber: 25, gold: 28, lowerIsBetter: false },
            "medizinball_1kg": { unit: "m", bronze: 5.5, silber: 6.5, gold: 7.5, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 1.50, silber: 1.70, gold: 1.85, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_50m": { unit: "sec", bronze: 10.3, silber: 9.3, gold: 8.4, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 36.0, silber: 29.0, gold: 22.5, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 35.0, silber: 30.5, gold: 26.0, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 0.85, silber: 0.95, gold: 1.05, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 2.60, silber: 2.90, gold: 3.20, lowerIsBetter: false },
            "drehwurf": { unit: "Pkt", bronze: 33, silber: 39, gold: 45, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 20, silber: 30, gold: 40, lowerIsBetter: false, note: "Grundsprung vorw√§rts ohne Zwischensprung" },
          }
        },
        "12-13": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "04:45", silber: "04:00", gold: "03:15", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 25, silber: 35, gold: 45, lowerIsBetter: false },
            "schwimmen_400m": { unit: "min:sec", bronze: "13:30", silber: "11:30", gold: "09:45", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "43:00", silber: "37:00", gold: "31:30", lowerIsBetter: true },
          },
          kraft: {
            "wurfball_200g": { unit: "m", bronze: 26, silber: 30, gold: 33, lowerIsBetter: false },
            "kugel_3kg": { unit: "m", bronze: 6.25, silber: 6.75, gold: 7.25, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 1.70, silber: 1.90, gold: 2.05, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_50m": { unit: "sec", bronze: 9.7, silber: 8.9, gold: 8.1, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 33.0, silber: 27.0, gold: 21.0, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 29.5, silber: 26.0, gold: 22.5, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 0.95, silber: 1.05, gold: 1.15, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 3.20, silber: 3.50, gold: 3.80, lowerIsBetter: false },
            "schleuderball_1kg": { unit: "m", bronze: 19.5, silber: 24.0, gold: 27.5, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 10, silber: 20, gold: 30, lowerIsBetter: false, note: "Grundsprung r√ºckw√§rts ohne Zwischensprung" },
          }
        },
        "14-15": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "04:20", silber: "03:40", gold: "03:00", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 35, silber: 45, gold: 60, lowerIsBetter: false },
            "schwimmen_400m": { unit: "min:sec", bronze: "12:00", silber: "10:15", gold: "08:50", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "32:00", silber: "28:00", gold: "24:00", lowerIsBetter: true },
          },
          kraft: {
            "wurfball_200g": { unit: "m", bronze: 30, silber: 34, gold: 37, lowerIsBetter: false },
            "kugel_4kg": { unit: "m", bronze: 7.0, silber: 7.5, gold: 8.0, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 1.90, silber: 2.05, gold: 2.25, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_100m": { unit: "sec", bronze: 17.0, silber: 15.4, gold: 14.1, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 31.0, silber: 25.5, gold: 20.0, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 24.0, silber: 21.5, gold: 19.0, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 1.10, silber: 1.20, gold: 1.30, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 3.80, silber: 4.10, gold: 4.40, lowerIsBetter: false },
            "schleuderball_1kg": { unit: "m", bronze: 23.5, silber: 28.0, gold: 32.0, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 10, silber: 15, gold: 20, lowerIsBetter: false, note: "Kreuzdurchschlag ohne Zwischensprung" },
          }
        },
        "16-17": {
          ausdauer: {
            "800m_lauf": { unit: "min:sec", bronze: "04:05", silber: "03:25", gold: "02:45", lowerIsBetter: true },
            "dauer_gelaendelauf": { unit: "min", bronze: 55, silber: 70, gold: 90, lowerIsBetter: false },
            "schwimmen_400m": { unit: "min:sec", bronze: "11:00", silber: "09:40", gold: "08:20", lowerIsBetter: true },
            "radfahren_10km": { unit: "min:sec", bronze: "27:00", silber: "23:30", gold: "20:30", lowerIsBetter: true },
          },
          kraft: {
            "wurfball_200g": { unit: "m", bronze: 34, silber: 38, gold: 42, lowerIsBetter: false },
            "kugel_5kg": { unit: "m", bronze: 7.5, silber: 8.0, gold: 8.5, lowerIsBetter: false },
            "standweitsprung": { unit: "m", bronze: 2.05, silber: 2.20, gold: 2.40, lowerIsBetter: false },
          },
          schnelligkeit: {
            "lauf_100m": { unit: "sec", bronze: 16.3, silber: 14.8, gold: 13.5, lowerIsBetter: true },
            "schwimmen_25m": { unit: "sec", bronze: 29.5, silber: 24.5, gold: 19.0, lowerIsBetter: true },
            "radfahren_200m": { unit: "sec", bronze: 22.0, silber: 19.5, gold: 17.0, lowerIsBetter: true },
          },
          koordination: {
            "hochsprung": { unit: "m", bronze: 1.20, silber: 1.30, gold: 1.40, lowerIsBetter: false },
            "weitsprung": { unit: "m", bronze: 4.30, silber: 4.60, gold: 4.90, lowerIsBetter: false },
            "schleuderball_1kg": { unit: "m", bronze: 27.5, silber: 32.0, gold: 36.5, lowerIsBetter: false },
            "seilspringen": { unit: "Anz", bronze: 10, silber: 15, gold: 20, lowerIsBetter: false, note: "Kreuzdurchschlag ohne Zwischensprung" },
          }
        }
      }
    };

    const EXERCISE_LABELS = {
      "800m_lauf": "800m Lauf",
      "dauer_gelaendelauf": "Dauer-/Gel√§ndelauf",
      "schwimmen_200m": "200m Schwimmen",
      "schwimmen_400m": "400m Schwimmen",
      "radfahren_10km": "10km Radfahren",
      "schlagball_80g": "Schlagball (80g)",
      "wurfball_200g": "Wurfball (200g)",
      "medizinball_1kg": "Medizinball (1kg)",
      "kugel_3kg": "Kugelsto√üen (3kg)",
      "kugel_4kg": "Kugelsto√üen (4kg)",
      "kugel_5kg": "Kugelsto√üen (5kg)",
      "standweitsprung": "Standweitsprung",
      "lauf_50m": "50m Lauf",
      "lauf_100m": "100m Lauf",
      "schwimmen_25m": "25m Schwimmen",
      "radfahren_200m": "200m Radfahren",
      "hochsprung": "Hochsprung",
      "weitsprung": "Weitsprung",
      "drehwurf": "Drehwurf",
      "schleuderball_1kg": "Schleuderball (1kg)",
      "seilspringen": "Seilspringen",
    };

    const CATEGORIES = {
      ausdauer: { label: "Ausdauer", icon: "üèÉ" },
      kraft: { label: "Kraft", icon: "üí™" },
      schnelligkeit: { label: "Schnelligkeit", icon: "‚ö°" },
      koordination: { label: "Koordination", icon: "üéØ" }
    };

    // ============================================
    // HILFSFUNKTIONEN
    // ============================================
    
    function calculateAgeForYear(birthYear) {
  const currentYear = new Date().getFullYear();
  return currentYear - birthYear;
}

function populateBirthYearDropdown() {
  const select = document.getElementById('birthYearInput');
  if (!select) return; // Falls noch nicht geladen
  
  const currentYear = new Date().getFullYear();
  
  // Leere erst vorhandene Optionen (au√üer der ersten)
  select.innerHTML = '<option value="">Geburtsjahr w√§hlen</option>';
  
  // Sch√ºler zwischen 10 und 18 Jahren
  for (let year = currentYear - 18; year <= currentYear - 10; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  }
}
    
    function timeToSeconds(timeStr) {
      if (typeof timeStr === 'number') return timeStr;
      const parts = timeStr.split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }

    function getAgeGroup(age) {
      if (age >= 10 && age <= 11) return "10-11";
      if (age >= 12 && age <= 13) return "12-13";
      if (age >= 14 && age <= 15) return "14-15";
      if (age >= 16 && age <= 17) return "16-17";
      return null;
    }

    function calculatePoints(value, exercise) {
      if (value === null || value === undefined || value === '') return 0;
      
      let numValue = parseFloat(String(value).replace(',', '.'));
      if (isNaN(numValue)) {
        if (String(value).includes(':')) {
          numValue = timeToSeconds(value);
        } else {
          return 0;
        }
      }
      
      let bronzeVal = exercise.bronze;
      let silberVal = exercise.silber;
      let goldVal = exercise.gold;
      
      if (exercise.unit === "min:sec") {
        bronzeVal = timeToSeconds(bronzeVal);
        silberVal = timeToSeconds(silberVal);
        goldVal = timeToSeconds(goldVal);
        if (String(value).includes(':')) {
          numValue = timeToSeconds(value);
        }
      }
      
      if (exercise.lowerIsBetter) {
        if (numValue <= goldVal) return 3;
        if (numValue <= silberVal) return 2;
        if (numValue <= bronzeVal) return 1;
        return 0;
      } else {
        if (numValue >= goldVal) return 3;
        if (numValue >= silberVal) return 2;
        if (numValue >= bronzeVal) return 1;
        return 0;
      }
    }

    function calculateOverallResult(points) {
      const categories = ['ausdauer', 'kraft', 'schnelligkeit', 'koordination'];
      const categoryPoints = categories.map(cat => points[cat] || 0);
      
      if (categoryPoints.some(p => p === 0)) {
        return { medal: null, total: categoryPoints.reduce((a, b) => a + b, 0) };
      }
      
      const total = categoryPoints.reduce((a, b) => a + b, 0);
      
      if (total >= 11) return { medal: 'gold', total };
      if (total >= 8) return { medal: 'silber', total };
      return { medal: 'bronze', total };
    }

    function getParticipantPoints(participant) {
  const age = calculateAgeForYear(participant.birth_year);  // ‚úÖ Alter berechnen!
  const ageGroup = getAgeGroup(age);  // ‚úÖ Mit berechnetem Alter
  const data = PERFORMANCE_DATA[participant.gender]?.[ageGroup];
  const points = {};
  
  if (data) {
    Object.keys(CATEGORIES).forEach(cat => {
      const catResults = participant.results?.[cat];
      if (catResults?.exercise && catResults?.value !== undefined && catResults?.value !== '') {
        const exercise = data[cat]?.[catResults.exercise];
        if (exercise) {
          points[cat] = calculatePoints(catResults.value, exercise);
        }
      }
    });
  }
  
  return points;
}

    function showLoading() {
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function setStatus(status, text) {
      const dot = document.getElementById('statusDot');
      const textEl = document.getElementById('statusText');
      dot.className = 'status-dot ' + status;
      textEl.textContent = text;
    }

    // ============================================
    // APP STATE
    // ============================================
    let participants = [];
    let editingId = null;
    let importData = [];

    // DOM-Elemente
    const listView = document.getElementById('listView');
    const formView = document.getElementById('formView');
    const importView = document.getElementById('importView');
    const emptyState = document.getElementById('emptyState');
    const participantList = document.getElementById('participantList');
    const headerActions = document.getElementById('headerActions');
    const addBtn = document.getElementById('addBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const closeFormBtn = document.getElementById('closeFormBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const formTitle = document.getElementById('formTitle');
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const birthYearInput = document.getElementById('birthYearInput');
    const genderInput = document.getElementById('genderInput');
    const disciplinesForms = document.getElementById('disciplinesForms');

    // Import-Elemente
    const closeImportBtn = document.getElementById('closeImportBtn');
    const cancelImportBtn = document.getElementById('cancelImportBtn');
    const confirmImportBtn = document.getElementById('confirmImportBtn');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const fileInput = document.getElementById('fileInput');
    const importPreview = document.getElementById('importPreview');
    const previewContent = document.getElementById('previewContent');

    // ============================================
    // SUPABASE OPERATIONS
    // ============================================
  async function loadParticipants() {
  try {
    setStatus('loading', 'Lade Daten...');
    const { data, error } = await db
      .from('participants')
      .select('*')
      .order('last_name', { ascending: true });
    
    if (error) throw error;
    
    participants = data || [];
    setStatus('online', `${participants.length} Teilnehmer geladen`);
    renderList();
  } catch (err) {
    console.error('Fehler beim Laden:', err);
    setStatus('offline', 'Verbindung fehlgeschlagen');
  }
}
   async function saveParticipantToDb(participant) {
  showLoading();
  try {
    if (participant.id) {
      // UPDATE bestehender Teilnehmer
      const { error } = await db
        .from('participants')
        .update({
          first_name: participant.first_name,
          last_name: participant.last_name,
          birth_year: participant.birth_year,
          gender: participant.gender,
          external_id: participant.external_id || null,
          results: participant.results
        })
        .eq('id', participant.id);
      if (error) throw error;
    } else {
      // INSERT neuer Teilnehmer
      const { error } = await db
        .from('participants')
        .insert({
          first_name: participant.first_name,
          last_name: participant.last_name,
          birth_year: participant.birth_year,
          gender: participant.gender,
          external_id: participant.external_id || null,
          results: participant.results || {}
        });
      if (error) throw error;
    }
    await loadParticipants();
  } catch (err) {
    console.error('Fehler beim Speichern:', err);
    alert('Fehler beim Speichern: ' + err.message);
  }
  hideLoading();
}

    async function deleteParticipantFromDb(id) {
      if (!confirm('Teilnehmer wirklich l√∂schen?')) return;
      
      showLoading();
      try {
        const { error } = await db
          .from('participants')
          .delete()
          .eq('id', id);
        if (error) throw error;
        await loadParticipants();
      } catch (err) {
        console.error('Fehler beim L√∂schen:', err);
        alert('Fehler beim L√∂schen: ' + err.message);
      }
      hideLoading();
    }

async function importParticipantsToDb(dataToImport) {
  showLoading();
  try {
    for (const p of dataToImport) {
      // Check ob Teilnehmer mit external_id schon existiert
      if (p.external_id) {
        const { data: existing } = await db
          .from('participants')
          .select('id')
          .eq('external_id', p.external_id)
          .maybeSingle();
        
        if (existing) {
          // UPDATE bestehender Teilnehmer (aber nicht die results!)
          await db
            .from('participants')
            .update({
              first_name: p.first_name,
              last_name: p.last_name,
              birth_year: p.birth_year,
              gender: p.gender
            })
            .eq('id', existing.id);
          continue;
        }
      }
      
      // INSERT neuer Teilnehmer
      await db
        .from('participants')
        .insert({
          external_id: p.external_id || null,
          first_name: p.first_name,
          last_name: p.last_name,
          birth_year: p.birth_year,
          gender: p.gender,
          results: {}
        });
    }
    
    await loadParticipants();
    hideImport();
  } catch (err) {
    console.error('Fehler beim Import:', err);
    alert('Fehler beim Import: ' + err.message);
  }
  hideLoading();
}

    // ============================================
    // RENDERING
    // ============================================
    function renderList() {
      if (participants.length === 0) {
        emptyState.classList.remove('hidden');
        participantList.innerHTML = '';
      } else {
        emptyState.classList.add('hidden');
        
        participantList.innerHTML = participants.map(p => {
          
          const points = getParticipantPoints(p);
          const result = calculateOverallResult(points);
          const age = calculateAgeForYear(p.birth_year);
          let medalBadge = '';
          if (result.medal) {
            const medalEmoji = result.medal === 'gold' ? 'ü•á' : result.medal === 'silber' ? 'ü•à' : 'ü•â';
            const medalClass = `medal-${result.medal}`;
            medalBadge = `<span class="medal-badge ${medalClass}">${medalEmoji} ${result.medal.charAt(0).toUpperCase() + result.medal.slice(1)}</span>`;
          }
          
          return `
            <div class="card" data-id="${p.id}">
              <div class="card-header">
                <div>
                  <div class="card-name">${p.first_name} ${p.last_name}</div>
                  <div class="card-meta">${age} Jahre, ${p.gender}</div>
                </div>
                ${medalBadge}
              </div>
              <div class="points-grid">
                ${Object.entries(CATEGORIES).map(([key, cat]) => `
                  <div class="points-item">
                    <div class="points-icon">${cat.icon}</div>
                    <div class="points-value points-${points[key] || 0}">${points[key] || '-'}</div>
                  </div>
                `).join('')}
              </div>
              <div class="card-actions">
                <button class="btn btn-secondary edit-btn" data-id="${p.id}">Bearbeiten</button>
                <button class="btn btn-danger delete-btn" data-id="${p.id}">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join('');

        // Event-Listener f√ºr Buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const participant = participants.find(p => p.id === id);
            if (participant) {
              loadParticipantToForm(participant);
              showForm(true);
            }
          });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            deleteParticipantFromDb(btn.dataset.id);
          });
        });
      }
    }

function renderDisciplineForms() {
  const birthYear = parseInt(birthYearInput.value);
  const gender = genderInput.value;
  
  if (!birthYear) {
    disciplinesForms.innerHTML = '<div class="form-section"><p style="color: #94a3b8; text-align: center;">Bitte Geburtsjahr w√§hlen</p></div>';
    return;
  }
  
  const age = calculateAgeForYear(birthYear);
  
  if (age < 10 || age > 17) {
    disciplinesForms.innerHTML = '<div class="form-section"><p style="color: #94a3b8; text-align: center;">Ung√ºltiges Geburtsjahr (Alter muss 10-17 Jahre sein)</p></div>';
    return;
  }
      
      const ageGroup = getAgeGroup(age);
      const data = PERFORMANCE_DATA[gender]?.[ageGroup];
      
      if (!data) {
        disciplinesForms.innerHTML = '<div class="form-section"><p style="color: #ef4444;">Keine Daten f√ºr diese Kombination</p></div>';
        return;
      }
      
      const currentResults = {};
      document.querySelectorAll('[data-category]').forEach(el => {
        const cat = el.dataset.category;
        const exerciseSelect = el.querySelector('.exercise-select');
        const valueInput = el.querySelector('.value-input');
        if (exerciseSelect && valueInput) {
          currentResults[cat] = {
            exercise: exerciseSelect.value,
            value: valueInput.value
          };
        }
      });
      
      disciplinesForms.innerHTML = Object.entries(CATEGORIES).map(([catKey, cat]) => {
        const exercises = data[catKey];
        const exerciseOptions = Object.keys(exercises).map(exKey => 
          `<option value="${exKey}">${EXERCISE_LABELS[exKey] || exKey}</option>`
        ).join('');
        
        return `
          <div class="form-section" data-category="${catKey}">
            <h3>${cat.icon} ${cat.label}</h3>
            <select class="exercise-select">
              <option value="">√úbung w√§hlen...</option>
              ${exerciseOptions}
            </select>
            <div class="exercise-details" id="details-${catKey}"></div>
          </div>
        `;
      }).join('');

      // Event-Listener f√ºr √úbungsauswahl
      document.querySelectorAll('.exercise-select').forEach(select => {
        select.addEventListener('change', () => {
          const catKey = select.closest('[data-category]').dataset.category;
          updateExerciseInfo(catKey);
        });
      });
      
      Object.entries(currentResults).forEach(([cat, result]) => {
        const section = document.querySelector(`[data-category="${cat}"]`);
        if (section && result.exercise) {
          const select = section.querySelector('.exercise-select');
          if (select) {
            select.value = result.exercise;
            updateExerciseInfo(cat);
            setTimeout(() => {
              const valueInput = section.querySelector('.value-input');
              if (valueInput && result.value) {
                valueInput.value = result.value;
                updatePointsDisplay(cat);
              }
            }, 10);
          }
        }
      });
    }

    function updateExerciseInfo(catKey) {
  const birthYear = parseInt(birthYearInput.value);  // ‚úÖ GE√ÑNDERT
  const gender = genderInput.value;
  
  if (!birthYear) return;  // ‚úÖ NEU: Abbruch wenn kein Geburtsjahr
  
  const age = calculateAgeForYear(birthYear);  // ‚úÖ NEU: Alter berechnen
  const ageGroup = getAgeGroup(age);
  const data = PERFORMANCE_DATA[gender]?.[ageGroup]?.[catKey];
  
  const section = document.querySelector(`[data-category="${catKey}"]`);
  const select = section.querySelector('.exercise-select');
  const detailsDiv = document.getElementById(`details-${catKey}`);
  
  const exerciseKey = select.value;
  if (!exerciseKey || !data?.[exerciseKey]) {
    detailsDiv.innerHTML = '';
    return;
  }
      
      const exercise = data[exerciseKey];
      const placeholder = exercise.unit === 'min:sec' ? 'MM:SS' : `Wert (${exercise.unit})`;
      
      detailsDiv.innerHTML = `
        <div class="result-input-group">
          <input type="text" class="value-input" placeholder="${placeholder}" inputmode="${exercise.unit === 'min:sec' ? 'text' : 'decimal'}">
          <div class="result-points result-points-0" id="points-${catKey}">0 Pkt</div>
        </div>
        <div class="thresholds">
          <span>ü•â ${exercise.bronze}${exercise.unit === 'min:sec' ? '' : ' ' + exercise.unit}</span>
          <span>ü•à ${exercise.silber}${exercise.unit === 'min:sec' ? '' : ' ' + exercise.unit}</span>
          <span>ü•á ${exercise.gold}${exercise.unit === 'min:sec' ? '' : ' ' + exercise.unit}</span>
        </div>
        ${exercise.note ? `<div class="exercise-note">${exercise.note}</div>` : ''}
      `;

      // Event-Listener f√ºr Wert-Eingabe
      const valueInput = section.querySelector('.value-input');
      valueInput.addEventListener('input', () => updatePointsDisplay(catKey));
    }

    function updatePointsDisplay(catKey) {
  const birthYear = parseInt(birthYearInput.value);  // ‚úÖ GE√ÑNDERT
  const gender = genderInput.value;
  
  if (!birthYear) return;  // ‚úÖ NEU: Abbruch wenn kein Geburtsjahr
  
  const age = calculateAgeForYear(birthYear);  // ‚úÖ NEU: Alter berechnen
  const ageGroup = getAgeGroup(age);
  const data = PERFORMANCE_DATA[gender]?.[ageGroup]?.[catKey];
  
  const section = document.querySelector(`[data-category="${catKey}"]`);
  const select = section.querySelector('.exercise-select');
  const valueInput = section.querySelector('.value-input');
  const pointsDiv = document.getElementById(`points-${catKey}`);
  
  if (!select || !valueInput || !pointsDiv) return;
  
  const exerciseKey = select.value;
  const exercise = data?.[exerciseKey];
  
  if (!exercise) return;
  
  const points = calculatePoints(valueInput.value, exercise);
  pointsDiv.textContent = `${points} Pkt`;
  pointsDiv.className = `result-points result-points-${points}`;
}

    // ============================================
    // FORMULAR-AKTIONEN
    // ============================================
    function showForm(editing = false) {
      listView.classList.add('hidden');
      formView.classList.remove('hidden');
      headerActions.classList.add('hidden');
      formTitle.textContent = editing ? 'Teilnehmer bearbeiten' : 'Neuer Teilnehmer';
      if (!editing) {
        renderDisciplineForms();
      }
    }

    function hideForm() {
      formView.classList.add('hidden');
      listView.classList.remove('hidden');
      headerActions.classList.remove('hidden');
      resetForm();
    }

   function resetForm() {
      firstNameInput.value = '';
      lastNameInput.value = '';
      birthYearInput.value = ''; 
      genderInput.value = 'weiblich';
      editingId = null;
      disciplinesForms.innerHTML = '';
    }

    function collectFormData() {
      const results = {};
      
      document.querySelectorAll('[data-category]').forEach(section => {
        const cat = section.dataset.category;
        const exerciseSelect = section.querySelector('.exercise-select');
        const valueInput = section.querySelector('.value-input');
        
        if (exerciseSelect?.value && valueInput?.value) {
          results[cat] = {
            exercise: exerciseSelect.value,
            value: valueInput.value
          };
        }
      });
      
        return {
            id: editingId,
            first_name: firstNameInput.value.trim(),
            last_name: lastNameInput.value.trim(),
            birth_year: parseInt(birthYearInput.value),
            gender: genderInput.value,
            results
        };
    }

    function loadParticipantToForm(participant) {
      firstNameInput.value = participant.first_name || '';
      lastNameInput.value = participant.last_name || '';
      birthYearInput.value = participant.birth_year || '';
      genderInput.value = participant.gender;
      editingId = participant.id;
      
      renderDisciplineForms();
      
      setTimeout(() => {
        Object.entries(participant.results || {}).forEach(([cat, result]) => {
          const section = document.querySelector(`[data-category="${cat}"]`);
          if (section) {
            const select = section.querySelector('.exercise-select');
            if (select && result.exercise) {
              select.value = result.exercise;
              updateExerciseInfo(cat);
              
              setTimeout(() => {
                const valueInput = section.querySelector('.value-input');
                if (valueInput && result.value) {
                  valueInput.value = result.value;
                  updatePointsDisplay(cat);
                }
              }, 10);
            }
          }
        });
      }, 10);
    }

    async function handleSave() {
      const data = collectFormData();
      
      if (!data.first_name || !data.last_name) {
        alert('Bitte Vor- und Nachname eingeben');
        return;
    }
      
      await saveParticipantToDb(data);
      hideForm();
    }

    // ============================================
    // IMPORT
    // ============================================
    function showImport() {
      listView.classList.add('hidden');
      importView.classList.remove('hidden');
      headerActions.classList.add('hidden');
      importData = [];
      importPreview.classList.add('hidden');
      confirmImportBtn.classList.add('hidden');
      fileInput.value = '';
    }

    function hideImport() {
      importView.classList.add('hidden');
      listView.classList.remove('hidden');
      headerActions.classList.remove('hidden');
      importData = [];
    }

function parseCSV(content) {
  const lines = content.split('\n').filter(l => l.trim());
  const results = [];
  const currentYear = new Date().getFullYear();
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    // Versuche verschiedene Trennzeichen
    let parts = line.includes(';') ? line.split(';') : line.split(',');
    parts = parts.map(p => p.trim().replace(/^["']|["']$/g, ''));
    
    let firstName, lastName, birthYear, gender, externalId;
    
    if (parts.length >= 5 && !isNaN(parseInt(parts[3]))) {
      // Format: external_id;Vorname;Nachname;Geburtsjahr;Geschlecht
      externalId = parts[0];
      firstName = parts[1];
      lastName = parts[2];
      birthYear = parseInt(parts[3]);
      gender = parts[4].toLowerCase();
    } else if (parts.length >= 4 && !isNaN(parseInt(parts[2]))) {
      // Format ohne external_id: Vorname;Nachname;Geburtsjahr;Geschlecht
      firstName = parts[0];
      lastName = parts[1];
      birthYear = parseInt(parts[2]);
      gender = parts[3].toLowerCase();
      externalId = null;
    } else if (parts.length >= 3) {
      // Altes Format: Name;Geburtsjahr;Geschlecht (Name aufteilen)
      const nameParts = parts[0].split(' ');
      firstName = nameParts[0] || '';
      lastName = nameParts.slice(1).join(' ') || '';
      birthYear = parseInt(parts[1]);
      gender = parts[2].toLowerCase();
      externalId = null;
    } else {
      continue; // Ung√ºltige Zeile √ºberspringen
    }
    
    // Geschlecht normalisieren
    if (gender === 'w' || gender === 'weiblich' || gender === 'f' || gender === 'female') {
      gender = 'weiblich';
    } else if (gender === 'm' || gender === 'm√§nnlich' || gender === 'maennlich' || gender === 'male') {
      gender = 'maennlich';
    } else {
      continue; // Ung√ºltige Zeile √ºberspringen
    }
    
    // Geburtsjahr validieren (zwischen 2006 und 2016 f√ºr 10-18 J√§hrige)
    if (firstName && birthYear >= currentYear - 18 && birthYear <= currentYear - 10) {
      results.push({ 
        external_id: externalId,
        first_name: firstName, 
        last_name: lastName, 
        birth_year: birthYear,
        gender 
      });
    }
  }
  
  return results;
}
  
  return results;
}
    function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const content = e.target.result;
    importData = parseCSV(content);
    
    if (importData.length === 0) {
      previewContent.innerHTML = '<p style="color: #ef4444;">Keine g√ºltigen Daten gefunden.<br>Format: Vorname;Nachname;Geburtsjahr;Geschlecht</p>';  // ‚úÖ "Geburtsjahr"
      importPreview.classList.remove('hidden');
      confirmImportBtn.classList.add('hidden');
      return;
    }
    
    previewContent.innerHTML = `
      <p style="color: #22c55e; margin-bottom: 0.5rem;">${importData.length} Teilnehmer erkannt:</p>
      <div style="max-height: 200px; overflow-y: auto;">
        ${importData.map(p => {
          const age = calculateAgeForYear(p.birth_year);  // ‚úÖ Alter berechnen
          return `<div style="font-size: 0.85rem; padding: 0.25rem 0;">${p.first_name} ${p.last_name} (${age}J, ${p.gender})</div>`;
        }).join('')}
      </div>
    `;
    importPreview.classList.remove('hidden');
    confirmImportBtn.classList.remove('hidden');
  };
  reader.readAsText(file);
}

    // ============================================
    // CSV EXPORT
    // ============================================
    function exportCSV() {
      const headers = ['External_ID', 'Vorname', 'Nachname', 'Geburtsjahr', 'Geschlecht', 'Ausdauer', 'Kraft', 'Schnelligkeit', 'Koordination', 'Gesamt', 'Ergebnis'];
      
      const rows = participants.map(p => {
        const age = calculateAgeForYear(p.birth_year);
        const points = getParticipantPoints(p);
        const result = calculateOverallResult(points);
        
        return [
          p.external_id || ''
          p.first_name,
          p.last_name,
          p.birth_year,
          p.gender,
          points.ausdauer || 0,
          points.kraft || 0,
          points.schnelligkeit || 0,
          points.koordination || 0,
          result.total,
          result.medal ? result.medal.charAt(0).toUpperCase() + result.medal.slice(1) : 'Nicht bestanden'
        ].join(';');
      });
      
      const csv = [headers.join(';'), ...rows].join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sportabzeichen_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    addBtn.addEventListener('click', () => {
      resetForm();
      showForm(false);
    });

    closeFormBtn.addEventListener('click', hideForm);
    cancelBtn.addEventListener('click', hideForm);
    saveBtn.addEventListener('click', handleSave);
    exportBtn.addEventListener('click', exportCSV);
    importBtn.addEventListener('click', showImport);

    closeImportBtn.addEventListener('click', hideImport);
    cancelImportBtn.addEventListener('click', hideImport);
    selectFileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    confirmImportBtn.addEventListener('click', () => importParticipantsToDb(importData));

    birthYearInput.addEventListener('change', renderDisciplineForms);
    genderInput.addEventListener('change', renderDisciplineForms);

    // ============================================
    // SERVICE WORKER & INIT
    // ============================================
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registriert'))
        .catch(err => console.log('Service Worker Fehler:', err));
    }

    // App starten
    populateBirthYearDropdown();
    loadParticipants();
  </script>
</body>
</html>
